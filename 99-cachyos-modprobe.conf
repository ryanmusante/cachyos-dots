# CachyOS modprobe configuration
# /etc/modprobe.d/99-cachyos-modprobe.conf
#
# Combined kernel module options and blacklists for AMD Strix Halo desktop.
# Consolidates: amdgpu.conf, blacklist.conf, mt7925e.conf

# ═══════════════════════════════════════════════════════════════════════════════
# AMDGPU - AMD GPU driver options
# ═══════════════════════════════════════════════════════════════════════════════
# NOTE: These parameters are ALSO set in kernel cmdline (sdboot-manage.conf).
# Both methods ensure settings apply regardless of boot timing.
#
#   modeset=1      - Enable kernel mode setting (required for display)
#   cwsr_enable=0  - Disable Compute Wave Save/Restore (Strix Halo MES firmware fix)
#   gpu_recovery=1 - Enable GPU reset on hang
#   runpm=0        - Disable runtime power management
#
# Verify: systool -vm amdgpu | grep parm

options amdgpu modeset=1 cwsr_enable=0 gpu_recovery=1 runpm=0

# ═══════════════════════════════════════════════════════════════════════════════
# MT7925E - MediaTek WiFi 7 driver options (Strix Halo specific)
# ═══════════════════════════════════════════════════════════════════════════════
# Disables PCIe Active State Power Management for MT7925 WiFi 7 chipsets.
# Fixes stability issues on Strix Halo systems.
# NOTE: Also set in kernel cmdline for early application.
#
# Safe to keep even if mt7925e is not present (module just won't load).
# Verify chipset: lspci | grep -i network

options mt7925e disable_aspm=1

# ═══════════════════════════════════════════════════════════════════════════════
# BLACKLIST - Modules to prevent from loading
# ═══════════════════════════════════════════════════════════════════════════════
# sp5100_tco: AMD watchdog timer - causes spurious log messages
#   "sp5100_tco: Watchdog hardware is disabled"
# Complements kernel cmdline nowatchdog parameter.
#
# install line ensures module cannot be loaded even if explicitly requested.

blacklist sp5100_tco
install sp5100_tco /usr/bin/true

# ═══════════════════════════════════════════════════════════════════════════════
# USB/BLUETOOTH - Autosuspend disabled (DUAL with kernel cmdline)
# ═══════════════════════════════════════════════════════════════════════════════
# These options are ALSO set in kernel cmdline (sdboot-manage.conf).
# Both methods ensure settings apply regardless of module load timing.
#
# btusb.enable_autosuspend=n  - Prevents Bluetooth connection drops
# usbcore.autosuspend=-1      - Prevents USB peripheral issues
#
# Verify: cat /sys/module/btusb/parameters/enable_autosuspend
# Verify: cat /sys/module/usbcore/parameters/autosuspend

options btusb enable_autosuspend=n
options usbcore autosuspend=-1

# ═══════════════════════════════════════════════════════════════════════════════
# NVME - Power saving disabled (DUAL with kernel cmdline)
# ═══════════════════════════════════════════════════════════════════════════════
# Disables NVMe Autonomous Power State Transitions (APST) for lowest latency.
# NOTE: Also set in kernel cmdline for early application.
#
# Verify: cat /sys/module/nvme_core/parameters/default_ps_max_latency_us

options nvme_core default_ps_max_latency_us=0
